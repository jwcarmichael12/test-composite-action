xpname: 'Create Component Version Composite Action'
description: 'Create Component Version, Add Version Link, Add Version Files, Add Version Properties'
inputs:
  component:
    description: 'Component Name/ID'
    required: true
  versionname:
    description: 'Component Version Name'
    required: true
  description:
    description: 'Component version description'
    required: false
  linkName:
    description: 'Name of link to add to component version'
    required: false
  link:
    description: 'Value of the link to add to component version'
    required: false
  base:
    description: 'Local base directory containing files to upload if file upload is required'
    required: false
    default: ""
  offset:
    description: 'Target path offset (the directory in the version files to which these files should be added)'
    required: false
    default: ""
  include:
    description: 'An include file pattern for selecting files to add (may be repeated)'
    required: false
    default: "*"
  exclude:
    description: 'An exclude file pattern for excluding files (may be repeated). Overrides includes.'
    required: false
    default: ""
  saveExecuteBits:
    description: 'Saves execute bits for files.'
    required: true
    type: boolean
    default: false
  urlType:
    description: 'URL protocol to use to connect to DevOps Deploy hostname'
    required: false
    default: 'https:'
  hostname:
    description: 'DevOps Deploy hostname'
    required: true
  port:
    description: 'port'
    required: true
    default: '8443'
  username:
    description: 'username'
    required: false
  password:
    description: 'password'
    required: false
    secret: true
  authToken:
    description: 'DevOps Deploy authentication token'
    required: false
    secret: true
  disableSSLVerification:
    description: 'skip SSL certificate validation when making HTTPS requests and this is discouraged'
    required: true
    type: boolean
    default: false
runs:
  using: "composite"
  
  steps:
    # Download udclient package and command shell scripts from composite action github repository
    - uses: actions/checkout@v4
      with:
        repository: jwcarmichael12/test-composite-action
        sparse-checkout: |
          artifacts/devops-deploy-client.zip
          scripts/addVersionFiles.sh
        sparse-checkout-cone-mode: false
        path: deploy
        
    # Setup java environment needed to run the udclient
    - uses: actions/setup-java@v4
      with:
        distribution: 'adopt-openj9' # See 'Supported distributions' for available options
        java-version: '11'
        
    # Expand the udclient package to access the executable
    - name: Install udclient
      id: udclient-install
      run: unzip deploy/artifacts/devops-deploy-client.zip
      shell: bash
      
    # Create component version
    - name: Create component version
      id: create-component-version
      run: udclient/udclient createVersion -component "${{ inputs.component }}" -name "${{ inputs.versionname }}"  --importing true
      shell: bash
      env:
        DS_WEB_URL: ${{ inputs.urlType }}//${{ inputs.hostname }}:${{ inputs.port }}
        DS_AUTH_TOKEN: ${{ inputs.authtoken }}

    # Add Version Link if one is specified
    - name: Add component version link
      id: add-version-link
      if: inputs.linkName && inputs.link
      run: udclient/udclient addVersionLink -component "${{ inputs.component }}" -version "${{ inputs.versionname }}" -linkName "${{ inputs.linkName }}" -link "${{ inputs.link }}"
      shell: bash
      env:
        DS_WEB_URL: ${{ inputs.urlType }}//${{ inputs.hostname }}:${{ inputs.port }}
        DS_AUTH_TOKEN: ${{ inputs.authtoken }}

    # Add Version Files if specified
    - name: Add component version files
      id: add-version-files
      if: ${{ inputs.base }}
      run: |
        export&&deploy/scripts/addVersionFiles.sh
      shell: bash
      env:
        DS_WEB_URL: ${{ inputs.urlType }}//${{ inputs.hostname }}:${{ inputs.port }}
        DS_AUTH_TOKEN: ${{ inputs.authtoken }}
        FILES_CMD: "udclient/udclient"
        FILES_COMPONENTNAME: "${{ inputs.component }}"
        FILES_VERSIONNAME: "${{ inputs.versionname }}"
        FILES_BASE: "${{ inputs.base }}"
        FILES_OFFSET: "${{ inputs.offset }}"
        FILES_INCLUDE: "${{ inputs.include }}"
        FILES_EXCLUDE: "${{ inputs.exclude }}"
        FILES_SAVEEXECUTEBITS: ${{ inputs.saveExecuteBits }}
      
    # Tell devops deploy server that component version creation is complete
    - name: Finish Importing
      id: finish-importing
      run: udclient/udclient finishedImporting -component "${{ inputs.component }}" -version "${{ inputs.versionname }}"
      shell: bash
      env:
        DS_WEB_URL: ${{ inputs.urlType }}//${{ inputs.hostname }}:${{ inputs.port }}
        DS_AUTH_TOKEN: ${{ inputs.authtoken }}
